# 플레이 중인 방 입장 제한

- 방에 플레이어 2명이 입장하면 다른 플레이어가 추가로 입장하는 것을 제한
- 게임 진행 중 1명이 퇴장하면 남아 있는 플레이어의 화면에 승리 엔딩 화면 띄우기


PlaySceneManager 스크립트|
|:---:|

```C#
using System.Collections;
using Photon.Pun;
using UnityEngine;

// 포톤 관련 콜백 함수를 상속받기 위함
public class PlaySceneManager : MonoBehaviourPunCallbacks
{
    // 플레이어 스폰 위치
    public Transform[] playerSpawnPoints;

    (*)// 게임이 끝났는지
    (*)bool isEnding;

    // Start is called once before the first execution of Update after the MonoBehaviour is created
    void Start()
    {
        // 현재 방에 참여한 플레이어 인원
        int playerCount = PhotonNetwork.CurrentRoom.PlayerCount;

        // 플레이어 인원에 따라 다른 스폰 위치에 플레잉어 생성(1명이면 0번, 2명이면 1번)
        // 프리팹을 복제하여 생성함과 동시에 네트워크에서 동기화
        // 항상 Resources 폴더를 경로로 사용하므로 Player 오브젝트를 프리팹화할 때 Prefabs 폴더가 아닌 Resources 폴더에 넣었던 것
        // 복제할 오브젝트에 PhotonView 컴포넌트가 부여되어 있어야 함(동기화 담당 및 고유 ID 배정)
        PhotonNetwork.Instantiate("Player", playerSpawnPoints[playerCount - 1].position, Quaternion.identity);
    }

    // 코루틴 함수 + while문 또는 for문 + yield return null
    // Update() 함수 사용하지 않아도 매 프레임마다 코드가 실행되도록 반복 가능, 원할 때 종료 가능 
    // 스킬의 쿨타임과 같은 기능을 구현할 때 주로 사용
    // 엔딩 이후로 실행될 기능들
    public IEnumerator AfterEnding()
    {
        (*)isEnding = true;

        // 방에 접속되어 있을 때 PhotonNetwork.InRoom 변수는 true로 설정되어 있음
        // 그래서 이 조건을 달아서 반복문 실행
        // 방에서 나가기 전까지 반복
        while (PhotonNetwork.InRoom)
        {
            // 아무 키나 입력되었다면
            if (Input.anyKeyDown)
            {
                // 방에서 퇴장 시도
                PhotonNetwork.LeaveRoom();

                // 반복문을 끝내서 함수 탈출
                break;
            }
        }

        // 다음 프레임까지 쉬기
        yield return null;
    }

    // 방 퇴장에 성공하면 호출
    public override void OnLeftRoom()
    {
        // 1. StartScene 라는 이름의 씬 불러오기 (씬 전환)
        PhotonNetwork.LoadLevel("1_StartScene");

        // 마우스 커서 보이게
        Cursor.visible = true;

        // 마우스 커서가 움직일 수 있도록 잠금 해제
        Cursor.lockState = CursorLockMode.None;
    }

    (*)// 방에 새로운 플레이어가 입장하면 호출
    (*)public override void OnPlayerEnteredRoom(Photon.Realtime.Player newPlayer)
    (*){
        (*)// 방 인원 수가 최대 인원 수와 같아지면
        (*)if (PhotonNetwork.CurrentRoom.PlayerCount == PhotonNetwork.CurrentRoom.MaxPlayers)
        (*){
            (*)// 비공개방으로 전환
            (*)PhotonNetwork.CurrentRoom.IsOpen = false;
            (*)// 목록에서 숨기기
            (*)PhotonNetwork.CurrentRoom.IsVisible = false;
        (*)}
    (*)}

    (*)// 방에서 플레이어가 퇴장하면 호출
    (*)public override void OnPlayerLeftRoom(Photon.Realtime.Player otherPlayer)
    (*){
        (*)// 승패가 난 상태에서는 실행 금지
        (*)if (isEnding) return;

        (*)// 모든 PhotonView 컴포넌트를 가져와서 반복
        (*)foreach (var player in FindObjectsOfType<PhotonView>())
        (*){
            (*)// 퇴장한 플레이어의 ActorNumber와 다른 ActorNumber를 가진 플레이어 찾기
            (*)if (player.Owner.ActorNumber != otherPlayer.ActorNumber)
            (*){
                (*)// 살아남은 플레이어에게 승리시 엔딩 기능 실행
                (*)StartCoroutine(player.GetComponent<PlayerHP>().Ending("승리"));
            (*)}
        (*)}
    (*)}
}
```

