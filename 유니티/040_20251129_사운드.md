# 사운드

배경음악, 효과음(총, 버튼, 걷기)

Window &rarr; Package Manager &rarr; My Assets &rarr; 추가한 에셋 다운로드 및 임포트 &rarr; 필요한 음악 파일 제외 삭제 &rarr; 새 폴더(7_AudioClips)에 정리

- 사용할 수 있는 사운드 파일 아이콘: <img width="20" height="18" alt="스크린샷 2025-11-29 오후 9 02 11" src="https://github.com/user-attachments/assets/994a44a2-9c63-4770-99c1-79c1a1b0a54e" />

<br>

## 사운드 인스펙터창

<img width="501" height="810" alt="스크린샷 2025-11-29 오후 9 23 12" src="https://github.com/user-attachments/assets/effc91cf-6a4a-4a09-bfb7-6c90a7e1440a" />

<br>

## 사운드 삽입

게임 안에서 재생하기 위해 필요한 컴포넌트

- Audio Source 컴포넌트
  - 오디오 클립 재생
  - 기본적으로 들어 있지 않아서 추가해야 함
- Audio Listener 컴포넌트
  - 게임 안의 소리 수신
  - 기본적으로 Main Camera 오브젝트에 들어 있음

StartScene &rarr; Create Empty(AudioManager) &rarr; Add Component &rarr; Audio Source|<img width="760" height="576" alt="스크린샷 2025-11-29 오후 9 34 14" src="https://github.com/user-attachments/assets/45cc6dd3-cfa3-454b-8fa1-6342e6445a39" />
|:---:|:---:|
Main Camera 내 Audio Listener|<img width="758" height="676" alt="스크린샷 2025-11-29 오후 9 38 09" src="https://github.com/user-attachments/assets/91473619-41bd-41a4-abac-5772159d427c" />

<br>

### 배경 음악 추가

StartScene에 추가한 AudioManager에 배경 음악 파일 추가|<img width="757" height="790" alt="스크린샷 2025-11-29 오후 9 45 16" src="https://github.com/user-attachments/assets/9cc3c6ea-8022-4733-958e-c77bd621bc67" />

- Play On Awake
  - 게임이 시작되자마자 배경 음악이 실행되는데 원하지 않을 경우 체크 해제
- Loop
  - 반복 재생
- Volume
  - 음량 조절

<br>

#### 배경 음악 유지


StartScene에서 PlayScene 전환 후, 배경 음악은 재생이 안됨 
&rarr; StartScene의 AudioManager를 복사하여 PlayScene에 배치하면 음악 재생되긴 하지만 이어서 재생되는 것이 아니라 끊긴 후 다시 시작 하므로 다른 방법 필요
&rarr; 새 스크립트 생성 후 AudioManager에 컴포넌트로 추가


AudioManager 스크립트|
|:---:|

```C#
using UnityEngine;

public class AudioManager : MonoBehaviour
{
    // Start()보다 먼저 호출되는 함수
    // 순서가 중요한 기능이 있을 때는 Awake()사용
    private void Awake()
    {
        // 인수로 지정한 오브젝트는 씬이 전환되어도 유지 (ex. 배경음악)
        // 자식 오브젝트만 단독으로 유지할 수 없고, 부모 오브젝트까지 유지해야 함
        // 씬 전환 시 삭제되지 않도록 유지
        DontDestroyOnLoad(gameObject);
    }
}
```

StartScene의 DontDestroyOnLoad 하위로 자동으로 들어감|씬이 전환되어도 유지(PlayScene)
|:---:|:---:|
<img width="220" height="155" alt="스크린샷 2025-11-30 오전 12 07 10" src="https://github.com/user-attachments/assets/3f9f1be6-8cc3-400f-b5c8-5ead453214e5" />|<img width="220" height="205" alt="스크린샷 2025-11-30 오전 12 07 44" src="https://github.com/user-attachments/assets/01e3e839-e739-4459-8714-8141d264a5fe" />

<br>

#### 중복 방지

이전 씬으로 전환 시, 동일한 오브젝트가 생성되어 소리가 겹쳐서 들리는 것 방지

오브젝트 중복 생성|
|:---:|
<img width="219" height="172" alt="스크린샷 2025-11-30 오전 1 33 23" src="https://github.com/user-attachments/assets/b87f7e45-ef6e-4aaa-bafd-db6f3d10b649" />|

<br>

##### 게임 중단 기능 구현

ESC 키 두번 누르면 게임 중단

- ESC 키를 누르는 순간 한 번 더 누르면 게임 종료 예정 문구 띄우기

PlayScene &rarr; Canvas &rarr; UI &rarr; Legacy &rarr; Text(WarningTxt) &rarr; 경고 문구 작성

PlaySceneManager 스크립트|
|:---:|

```C#
using System.Collections;
using Photon.Pun;
using UnityEngine;

// 포톤 관련 콜백 함수를 상속받기 위함
public class PlaySceneManager : MonoBehaviourPunCallbacks
{
    // 플레이어 스폰 위치
    public Transform[] playerSpawnPoints;
    (*)// ESC 경고 문구
    (*)public GameObject warningTxt;

    // 게임이 끝났는지
    bool isEnding;

    // Start is called once before the first execution of Update after the MonoBehaviour is created
    void Start()
    {
        // 현재 방에 참여한 플레이어 인원
        int playerCount = PhotonNetwork.CurrentRoom.PlayerCount;

        // 플레이어 인원에 따라 다른 스폰 위치에 플레잉어 생성(1명이면 0번, 2명이면 1번)
        // 프리팹을 복제하여 생성함과 동시에 네트워크에서 동기화
        // 항상 Resources 폴더를 경로로 사용하므로 Player 오브젝트를 프리팹화할 때 Prefabs 폴더가 아닌 Resources 폴더에 넣었던 것
        // 복제할 오브젝트에 PhotonView 컴포넌트가 부여되어 있어야 함(동기화 담당 및 고유 ID 배정)
        PhotonNetwork.Instantiate("Player", playerSpawnPoints[playerCount - 1].position, Quaternion.identity);
    }

    (*)private void Update()
    (*){
        (*)// ESC키를 입력했다면
        (*)if (Input.GetKeyDown(KeyCode.Escape))
        (*){
            (*)StartCoroutine(AfterEsc());
        (*)}
    (*)}

    (*)// ESC키 입력 이후로 실행될 기능들
    (*)public IEnumerator AfterEsc()
    (*){
        (*)// 경고 문구 활성화
        (*)warningTxt.SetActive(true);

        (*)float time = 0;

        (*)// ESC키를 눌렀어도 중단하고 싶지 않을 경우를 위해 time 추가
        (*)// 방에서 나가거나 3초가 지나기 전까지 반복
        (*)while (PhotonNetwork.InRoom && time < 3)
        (*){

            (*)// AfterEsc() 함수 안에서도 ESC 키가 입력되었다고 판단하기 때문에 연속적으로 인식하지 못하도록 time != 0 조건 추가
            (*)// ESC키를 한 번 더 입력했다면
            (*)if (time != 0 && Input.GetKeyDown(KeyCode.Escape))
            (*){
                (*)// 방에서 퇴장 시도
                (*)PhotonNetwork.LeaveRoom();

                (*)// 반복문을 끝내서 함수 탈출
                (*)break;
            (*)}

            (*)// 시간 재기
            (*)time += Time.deltaTime;

            (*)// 업데이트 함수가 호출될 때까지 쉬기
            (*)yield return null;
        (*)}

        (*)// 경고 문구 비활성화
        (*)warningTxt.SetActive(false);
    (*)}

    // 코루틴 함수 + while문 또는 for문 + yield return null
    // Update() 함수 사용하지 않아도 매 프레임마다 코드가 실행되도록 반복 가능, 원할 때 종료 가능 
    // 스킬의 쿨타임과 같은 기능을 구현할 때 주로 사용
    // 엔딩 이후로 실행될 기능들
    public IEnumerator AfterEnding()
    {
        isEnding = true;

        // 방에 접속되어 있을 때 PhotonNetwork.InRoom 변수는 true로 설정되어 있음
        // 그래서 이 조건을 달아서 반복문 실행
        // 방에서 나가기 전까지 반복
        while (PhotonNetwork.InRoom)
        {
            // 아무 키나 입력되었다면
            if (Input.anyKeyDown)
            {
                // 방에서 퇴장 시도
                PhotonNetwork.LeaveRoom();

                // 반복문을 끝내서 함수 탈출
                break;
            }
        }

        // 다음 프레임까지 쉬기
        yield return null;
    }

    // 방 퇴장에 성공하면 호출
    public override void OnLeftRoom()
    {
        // 1. StartScene 라는 이름의 씬 불러오기 (씬 전환)
        PhotonNetwork.LoadLevel("1_StartScene");

        // 마우스 커서 보이게
        Cursor.visible = true;

        // 마우스 커서가 움직일 수 있도록 잠금 해제
        Cursor.lockState = CursorLockMode.None;
    }

    // 방에 새로운 플레이어가 입장하면 호출
    public override void OnPlayerEnteredRoom(Photon.Realtime.Player newPlayer)
    {
        // 방 인원 수가 최대 인원 수와 같아지면
        if (PhotonNetwork.CurrentRoom.PlayerCount == PhotonNetwork.CurrentRoom.MaxPlayers)
        {
            // 비공개방으로 전환
            PhotonNetwork.CurrentRoom.IsOpen = false;
            // 목록에서 숨기기
            PhotonNetwork.CurrentRoom.IsVisible = false;
        }
    }

    // 방에서 플레이어가 퇴장하면 호출
    public override void OnPlayerLeftRoom(Photon.Realtime.Player otherPlayer)
    {
        // 승패가 난 상태에서는 실행 금지
        if (isEnding) return;

        // 모든 PhotonView 컴포넌트를 가져와서 반복
        foreach (var player in FindObjectsOfType<PhotonView>())
        {
            // 퇴장한 플레이어의 ActorNumber와 다른 ActorNumber를 가진 플레이어 찾기
            if (player.Owner.ActorNumber != otherPlayer.ActorNumber)
            {
                // 살아남은 플레이어에게 승리시 엔딩 기능 실행
                StartCoroutine(player.GetComponent<PlayerHP>().Ending("승리"));
            }
        }
    }
}
```

WarningTxt 비활성화 &rarr; PlaySceneManager 내 Play Scene Manager 컴포넌트의 변수 Warning Txt 값에 WarningTxt 오브젝트 드래그

WarningTxt 오브젝트|<img width="749" height="490" alt="스크린샷 2025-11-30 오전 1 39 52" src="https://github.com/user-attachments/assets/eee8500a-3bae-4c66-bb59-a663fd0c5b52" />
|:---:|:---:|
PlaySceneManager 오브젝트|<img width="749" height="345" alt="스크린샷 2025-11-30 오전 1 40 39" src="https://github.com/user-attachments/assets/db048ab0-dde4-40e8-92ab-daea4db97d8b" />

