# 적 캐릭터가 플레이어 캐릭터의 상태에 따라 움직이는 AI 추가

1. [장애물을 인식하고 최단 경로를 찾는 기능](#)
2. [목적지를 설정하거나 길찾기를 취소하는 기능](#)

<br>

## 내비게이션

유니티에서 제공하는 길 찾기 AI(NAvigation) 활용
- Window &rarr; AI &rarr; Navigation

<br>

<img width="456" height="454" alt="스크린샷 2025-10-10 오전 2 36 29" src="https://github.com/user-attachments/assets/d890a078-2b48-41ab-a825-033b4d81330d" />

- Agent Radius
  - Agent의 반지름과 높이
  - 크기 설정
- Agent Height
  - Agent의 높이
  - 크기 설정
- Max Slope
  - Agent가 올라갈 수 있는 최대 경사로
- Step Height
  - Agent가 올라갈 수 있는 턱의 높이 제한
- Generated Off Mesh Links
  - Agent가 지도 내에서 점프 및 낙하하는 설정

### Ground 오브젝트에 지도 그리기

Ground 오브젝트에 NavMesh Surface 컴포넌트 추가 &rarr; Bake

<img width="735" height="802" alt="스크린샷 2025-10-10 오전 3 04 43" src="https://github.com/user-attachments/assets/3a0f23de-e06b-4538-83ce-a2019e43fc6b" />

<br>

## 플레이어 캐릭터 쫒아가기

지도 위에서 적 캐릭터가 플레이어 캐릭터를 찾아 쫒아가는 기능

Enemy 오브젝트에 Nav Mesh Agent 컴포넌트 추가|
|:---:|
<img width="449" height="396" alt="스크린샷 2025-10-10 오전 3 14 50" src="https://github.com/user-attachments/assets/f2da1727-f7db-41ac-ad2a-10c7ff663605" />|

- Agent Type
  - 내비게이션창의 Agent 탭에서 종류 선택
- Base Offset
  - Agent의 위치
- Speed
  - Agent의 이동 속도
- Angular Speed
  - Agent의 회전 속도
- Acceleration
  - Agent의 가속도
- Stopping Distance
  - 목적지에 도착하기 전 멈출 거리
- Auto Braking
  - 목적지에 도착하기 전 속도를 줄일지 여부
- Obstacle Avoidance
  - 장애물과의 충돌에 대한 Colider의 크기와 품질

```C#
using UnityEngine;
using UnityEngine.AI;
using UnityEngine.UI;

public class Enemy : MonoBehaviour
{
    // 적이 가질 수 있는 상태 목록
    public enum EnemyState
    {
        Idle,    // 기본
        Walk,    // 이동
        Attack,  // 공격
        Damaged, // 피격
        Dead,    // 죽음
    }

    // 상태를 담아둘 변수를 만들고, 기본 상태로 시작
    public EnemyState eState = EnemyState.Idle;

    // 적의 체력바
    public Slider hpBar;
    // 적의 체력
    public float hp = 100;

    // 플레이어
    Transform player;
    // NavMeshAgent 컴포넌트
    NavMeshAgent agent;
    // 플레이어와의 거리
    float distance;

    // 공격 받는 기능
    void Damaged(float damage)
    {
        // 공격 받은 데미지 만큼 체력 감소
        hp -= damage;

        // 감소한 체력을 체력바에 표시
        hpBar.value = hp;

        // 이동 중단
        agent.isStopped = true;
        // 경로 초기화
        agent.ResetPath();

        // 체력이 남아있다면
        if (hp > 0)
        {
            // 피격 상태로 전환
            eState = EnemyState.Damaged;
        }
        // 체력이 남아있지 않다면
        else
        {
            // 죽음 상태로 전환
            eState = EnemyState.Dead;
        }
    }

    // Start is called once before the first execution of Update after the MonoBehaviour is created
    void Start()
    {
        // Player 컴포넌트로 찾은 플레이어의 Transform 컴포넌트 가져오기
        // 책에서는 FindObjectOfType을 사용했는데 최신 버전은 사용불가라서 경고 뜨기에 경고에 나온 다른 함수로 대체
        player = FindFirstObjectByType<Player>().transform;

        // 나의 NavMeshAgent 컴포넌트 가져오기
        agent = GetComponent<NavMeshAgent>();
    }

    // Update is called once per frame
    void Update()
    {
        // 적과 플레이어 사이의 거리 계산
        distance = Vector3.Distance(transform.position, player.position);

        // 기본, 이동, 공격 상태일 때 할 일 나누기
        switch (eState)
        {
            case EnemyState.Idle: Idle(); break;
            case EnemyState.Walk: Walk(); break;
            case EnemyState.Attack: Attack(); break;
        }
    }

    // 기본 상태일 때 계속 할 일
    void Idle()
    {
        // 플레이어와의 거리가 8 이하라면
        if (distance <= 8)
        {
            // 이동 상태로 전환
            eState = EnemyState.Walk;
            // 이동 시작
            agent.isStopped = false;
        }
    }

    // 이동 상태일 때 계속 할 일
    void Walk()
    {
        // 플레이어와의 거리가 8보다 크다면
        if (distance > 8)
        {
            // 기본 상태로 전환
            eState = EnemyState.Idle;
            // 이동 중단
            agent.isStopped = true;
            // 경로 초기화
            agent.ResetPath();
        }
        // 플레이어와의 거리가 2 이하라면
        else if (distance <= 2)
        {
            // 공격 상태로 전환
            eState = EnemyState.Attack;
            // 이동 중단
            agent.isStopped = true;
            // 경로 초기화
            agent.ResetPath();
        }
        // 다른 상태로 전환하지 않을 때는
        else
        {
            // 플레이어의 위치를 목적지로 설정
            agent.SetDestination(player.position);
        }
    }

    // 공격 상태일 때 계속 할 일
    void Attack()
    {
        // 플레이어와의 거리가 2보다 크다면
        if (distance > 2)
        {
            // 이동 상태로 전환
            eState = EnemyState.Walk;
            // 이동 시작
            agent.isStopped = false;
        }
    }
}
```

https://github.com/user-attachments/assets/66c35ea3-5b17-4859-9c51-763986ded686



https://github.com/user-attachments/assets/35e70185-4703-45f5-8dc0-29aee5f1278a


https://github.com/user-attachments/assets/d509dc36-fd73-4563-b7d9-d494f4aa771e

총에 맞으면 멈추고 더 이상 따라오지 않음. 이 현상은 차후에 애니메이션 적용하고 나서 수정 예정

<br>

# 프로토 타입 완성

이제 알파 버전 제작


