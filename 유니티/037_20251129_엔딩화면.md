# 엔딩 화면 구현

캐릭터가 죽음 시, 조건에 맞게 __"패배"__ & __"승리"__ 엔딩 화면에 구현

<br>

## UI

2.PlayScene &rarr; Canvas 우클릭 &rarr; UI &rarr; Image (Ending)|<img width="618" height="818" alt="스크린샷 2025-11-28 오후 4 43 35" src="https://github.com/user-attachments/assets/0084a031-7959-4bc1-a0f3-4e2710cf318c" />
|:---:|:---:|
Ending 위치, 앵커프리셋 설정|<img width="585" height="424" alt="스크린샷 2025-11-28 오후 5 03 57" src="https://github.com/user-attachments/assets/336d55d6-a487-4d3b-b93c-7431dc10138a" />
Ending 색상 및 불투명도 조절|<img width="588" height="424" alt="스크린샷 2025-11-28 오후 5 04 36" src="https://github.com/user-attachments/assets/13620b1a-9e02-4431-afa3-a46fc74413b1" />
Ending 우클릭 &rarr; UI &rarr; Legacy &rarrr; Text|<img width="717" height="882" alt="스크린샷 2025-11-28 오후 5 10 27" src="https://github.com/user-attachments/assets/2773e0e2-2a19-4970-9473-2872322a8f9c" />
Ending 위에 "-승리-" 작성, 위치 및 텍스트 설정 조절|<img width="589" height="424" alt="스크린샷 2025-11-28 오후 5 15 17" src="https://github.com/user-attachments/assets/70842e10-2034-496d-a552-8c09c9e232a4" />
텍스트 복제해서 설정 적합하게 맞추고 "아무 키나 누르면 종료" 작성|<img width="586" height="420" alt="스크린샷 2025-11-28 오후 5 18 43" src="https://github.com/user-attachments/assets/fb523c77-d285-462a-80f1-63f0d13cdf69" />
Ending 비활성화|<img width="268" height="58" alt="스크린샷 2025-11-28 오후 5 26 53" src="https://github.com/user-attachments/assets/efdbd8f8-fbf9-4d59-a484-4e436712cab5" />

<br>

## 코드 작성

### 패배

PlayerHp 스크립트|
|:---:|

```C#
using System.Collections;
using Photon.Pun;
using UnityEngine;
using UnityEngine.UI;

public class PlayerHP : MonoBehaviour
{
    // 플레이어의 체력
    public float hp = 100;
    // 플레이어의 체력바 (머리 위)
    public Slider hpBar_World;

    // 플레이어의 Animator 컴포넌트
    Animator anim;
    // 플레이어의 PhotonView 컴포넌트
    PhotonView pv;
    // 플레이어의 체력바 (화면)
    Slider hpBar_Screen;
    (*)// Canvas 오브젝트
    (*)Transform canvas;

    // Start is called once before the first execution of Update after the MonoBehaviour is created
    void Start()
    {
        anim = GetComponent<Animator>();
        pv = GetComponent<PhotonView>();

        // 내 캐릭터일 때만 실행
        if (pv.IsMine)
        {
            // Canvas 검색해서 가져오기
            (*)canvas = GameObject.Find("Canvas").transform;

            // Canvas의 부모를 나로 설정
            canvas.SetParent(transform);

            // 화면 왼쪽 상단에 있는 플레이어의 체력바 가져오기
            hpBar_Screen = canvas.GetComponentInChildren<Slider>();
        }
    }

    // Update is called once per frame
    void Damaged(float damage)
    {
        // 공격받았음을 RPC 통신으로 모두에게 전달
        pv.RPC("RPC_Damgaged", RpcTarget.All, damage);
    }

    [PunRPC]
    void RPC_Damaged(float damage)
    {
        // 공격 받은 데미지만큼 체력 감소
        hp -= damage;

        // 체력바에 체력 표시
        hpBar_World.value = hp;

        // 내 캐릭터일 때만 실행
        if (pv.IsMine)
        {
            // 화면 체력바에 체력 표시
            hpBar_Screen.value = hp;

            // 체력이 남아있다면
            if (hp > 0)
            {
                // 피격 애니메이션 실행
                anim.SetTrigger("damaged");
            }
            // 체력이 남아있지 않다면
            else
            {
                // 죽음 애니메이션 실행
                anim.SetTrigger("dead");

                // 플레이어 기능 중단
                GetComponentInChildren<CamerRotate>().enabled = false;

                (*)// 패배 시 엔딩 기능 실행
                (*)// 코루틴 함수 호출
                (*)StartCoroutine(Ending("패배"));
            }
        }

        // 내 캐릭터가 아니어도 체력이 남아있지 않다면
        if (hp <= 0)
        {
            // 죽은 후에는 총에 맞지 않도록 태그 해제
            tag = "Untagged";

            // 플레이어의 기능 중단
            GetComponent<Player>().enabled = false;
            GetComponent<PlayerFire>().enabled = false;
        }
    }

    (*)// 코루틴 함수
    (*)// 코루틴 함수가 리턴하는 값은 IEnumerator 타입
    (*)// 엔딩에서 실행될 기능들
    (*)public IEnumerator Ending(string result)
    (*){
        (*)// yield return을 이용해 잠시 함수에서 벗어나 다른 작업을 하고 올 수 있음
        (*)// 동시에 실행 X, 원하는 시간만큼 잠시 중단되었다가 재실행
        (*)// 1초동안 아래 코드가 실행되지 않도록 쉬기
        (*)yield return new WaitForSeconds(1f);

        (*)// Canvas의 2번째 자식인 Ending 오브젝트 가져오기
        (*)Transform ending = canvas.GetChild(2);

        (*)// 결과 UI 출력
        (*)ending.GetChild(0).GetComponent<Text>().text = "- " + result + " -";

        (*)// 결과 화면 활성화
        (*)ending.gameObject.SetActive(true);
    (*)}
}
```

"- 패배 -"로 변경된 엔딩 장면이 화면에 띄워짐. 현재는 확인 불가(캡처가 안되서 사진이 없음)

<br>

### 승리

PlayerHp 스크립트|
|:---:|

```C#
using System.Collections;
using Photon.Pun;
using UnityEngine;
using UnityEngine.UI;

public class PlayerHP : MonoBehaviour
{
    // 플레이어의 체력
    public float hp = 100;
    // 플레이어의 체력바 (머리 위)
    public Slider hpBar_World;

    // 플레이어의 Animator 컴포넌트
    Animator anim;
    // 플레이어의 PhotonView 컴포넌트
    PhotonView pv;
    // 플레이어의 체력바 (화면)
    Slider hpBar_Screen;
    // Canvas 오브젝트
    Transform canvas;

    // Start is called once before the first execution of Update after the MonoBehaviour is created
    void Start()
    {
        anim = GetComponent<Animator>();
        pv = GetComponent<PhotonView>();

        // 내 캐릭터일 때만 실행
        if (pv.IsMine)
        {
            // Canvas 검색해서 가져오기
            canvas = GameObject.Find("Canvas").transform;

            // Canvas의 부모를 나로 설정
            canvas.SetParent(transform);

            // 화면 왼쪽 상단에 있는 플레이어의 체력바 가져오기
            hpBar_Screen = canvas.GetComponentInChildren<Slider>();
        }
    }

    // Update is called once per frame
    (*)public void Damaged(float damage, int hitter)
    {
        // 공격받았음을 RPC 통신으로 모두에게 전달
        (*)// 공격한 사람의 정보 전달
        (*)pv.RPC("RPC_Damgaged", RpcTarget.All, damage, hitter);
    }

    [PunRPC]
    (*)void RPC_Damaged(float damage, int hitter)
    {
        // 공격 받은 데미지만큼 체력 감소
        hp -= damage;

        // 체력바에 체력 표시
        hpBar_World.value = hp;

        // 내 캐릭터일 때만 실행
        if (pv.IsMine)
        {
            // 화면 체력바에 체력 표시
            hpBar_Screen.value = hp;

            // 체력이 남아있다면
            if (hp > 0)
            {
                // 피격 애니메이션 실행
                anim.SetTrigger("damaged");
            }
            // 체력이 남아있지 않다면
            else
            {
                // 죽음 애니메이션 실행
                anim.SetTrigger("dead");

                // 플레이어 기능 중단
                GetComponentInChildren<CamerRotate>().enabled = false;

                // 패배 시 엔딩 기능 실행
                // 코루틴 함수 호출
                StartCoroutine(Ending("패배"));
            }
        }

        // 내 캐릭터가 아니어도 체력이 남아있지 않다면
        if (hp <= 0)
        {
            // 죽은 후에는 총에 맞지 않도록 태그 해제
            tag = "Untagged";

            // 플레이어의 기능 중단
            GetComponent<Player>().enabled = false;
            GetComponent<PlayerFire>().enabled = false;

            (*)// 승리한 플레이어 찾아서 PlayerHp 컴포넌트 가져오기
            (*)PlayerHP winner = PhotonNetwork.GetPhotonView(hitter).GetComponent<PlayerHP>();

            (*)// 승리한 플레이어에게 승리시 엔딩 기능 실행
            (*)StartCoroutine(winner.Ending("승리"));
        }
    }

    // 코루틴 함수
    // 코루틴 함수가 리턴하는 값은 IEnumerator 타입
    // 엔딩에서 실행될 기능들
    public IEnumerator Ending(string result)
    {
        (*)// 내 캐릭터가 아니라면 함수 탈출하여 아래 코드 실행 불가
        (*)if (!pv.IsMine) yield break;

        // yield return을 이용해 잠시 함수에서 벗어나 다른 작업을 하고 올 수 있음
        // 동시에 실행 X, 원하는 시간만큼 잠시 중단되었다가 재실행
        // 1초동안 아래 코드가 실행되지 않도록 쉬기
        yield return new WaitForSeconds(1f);

        // Canvas의 2번째 자식인 Ending 오브젝트 가져오기
        Transform ending = canvas.GetChild(2);

        // 결과 UI 출력
        ending.GetChild(0).GetComponent<Text>().text = "- " + result + " -";

        // 결과 화면 활성화
        ending.gameObject.SetActive(true);

        (*)// 승리한 플레이어도 기능 실행 중단
        (*)// 플레이어의 기능 중단
        (*)GetComponent<Player>().enabled = false;
        (*)GetComponent<PlayerFire>().enabled = false;
        (*)GetComponentInChildren<CamerRotate>().enabled = false;
    }
}
```

PlayerFire 스크립트|
|:---:|

```C#
using JetBrains.Annotations;
using Photon.Pun;
using Unity.VisualScripting;
using UnityEngine;

public class PlayerFire : MonoBehaviour
{
    // 총 효과 프리팹을 담아둘 변수
    public GameObject shootEffectPref;

    // 플레이어의 Animator 컴포넌트
    Animator anim;
    // 플레이어의 Photon View 컴포넌트
    PhotonView pv;

    // Start is called once before the first execution of Update after the MonoBehaviour is created
    void Start()
    {
        anim = GetComponent<Animator>();
        pv = GetComponent<PhotonView>();

        // 마우스 커서 안 보이게
        Cursor.visible = false;

        // 마우스 커서가 게임 화면을 벗어나지 못하도록 잠금
        Cursor.lockState = CursorLockMode.Confined;
    }

    // Update is called once per frame
    void Update()
    {
        // 마우스 좌클릭을 누르는 순간, 내 캐릭터일 때만
        if (Input.GetMouseButtonDown(0) && pv.IsMine)
        {
            // 총 쏘는 애니메이션 실행
            anim.SetTrigger("shoot");

            // 화면 가운데에서 시작하는 Ray 생성
            Ray ray = Camera.main.ViewportPointToRay(new Vector2(0.5f, 0.5f));

            // Ray에 맞은 물체를 담아둘 변수
            RaycastHit hit;

            // Ray를 발사하고, Ray에 맞은 물체는 hit에 저장
            // 맞은 물체가 있을 때만
            if (Physics.Raycast(ray, out hit))
            {
                // 맞은 위치에, 맞은 표면의 수직이 되는 각도로 총 효과 프리팹의 복사본 생성
                GameObject shootEffect = Instantiate(shootEffectPref, hit.point + hit.normal * 0.01f, Quaternion.LookRotation(hit.normal));

                // 총알 자국을 맞은 오브젝트의 자식으로 설정
                shootEffect.transform.SetParent(hit.transform);

                // Ray에 맞은 물체가 적이라면
                if (hit.transform.tag == "Enemy")
                {
                    // 적에게 10만큼 공격 받으라고 전달
                    hit.transform.SendMessage("Damaged", 10);
                }

                // Ray에 맞은 물체가 플레이어라면
                if (hit.transform.tag == "Player")
                {
                    // 플레이어에게 10만큼 공격 받으라고 전달, 나의 ViewId 전달
                    hit.transform.GetComponent<PlayerHP>().Damaged(10, pv.ViewID);
                }
            }
        }
    }
}
```

본인 캐릭터의 공격으로 상대 캐릭터의 체력이 0이 되고 `"dead"` 애니메이션이 실행되었으면 "- 승리 -" 가 적힌 엔딩 화면이 띄워짐
